<!-- Wedding Photo Sorter HTML Interface -->
<!-- Save this file as "index.html" in the same directory as the JS file -->

<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Wedding Photo Sorter</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f5f5f7;
      display: flex;
      flex-direction: column;
      height: 100vh;
      color: #333;
    }
    
    .header {
      background-color: #fff;
      padding: 15px 20px;
      border-bottom: 1px solid #ddd;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .title {
      font-size: 20px;
      font-weight: 500;
    }
    
    .stats {
      font-size: 14px;
      color: #666;
      display: flex;
      gap: 20px;
    }
    
    .stat-group {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    
    .stat-value {
      font-weight: bold;
      color: #333;
    }
    
    .setup-container {
      padding: 50px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      flex: 1;
    }
    
    .resume-message {
      background-color: #e8f5e9;
      color: #2e7d32;
      padding: 15px 25px;
      border-radius: 6px;
      margin-bottom: 20px;
      display: none;
    }
    
    .resume-message.visible {
      display: block;
    }
    
    .photo-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
      overflow: hidden;
      position: relative;
    }
    
    .photo-view {
      max-width: 100%;
      max-height: calc(100vh - 180px);
      object-fit: contain;
      border-radius: 4px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    .controls {
      background-color: #fff;
      padding: 20px;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 30px;
      border-top: 1px solid #ddd;
    }
    
    .control-group {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .key {
      display: inline-block;
      padding: 8px 12px;
      background-color: #f0f0f0;
      border-radius: 4px;
      font-family: monospace;
      font-weight: bold;
      box-shadow: 0 2px 3px rgba(0, 0, 0, 0.1);
      min-width: 15px;
      text-align: center;
    }
    
    .action {
      font-size: 14px;
    }
    
    button {
      padding: 12px 20px;
      font-size: 16px;
      background-color: #0071e3;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    
    button:hover {
      background-color: #0077ed;
    }
    
    button:active {
      background-color: #0062c3;
    }
    
    button + button {
      margin-left: 10px;
    }
    
    .path-display {
      font-size: 13px;
      color: #666;
      margin-top: 8px;
      max-width: 500px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .category-badge {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      padding: 15px 30px;
      font-size: 24px;
      font-weight: bold;
      color: white;
      border-radius: 8px;
      opacity: 0;
      transition: opacity 0.2s;
    }
    
    .yes-badge {
      background-color: rgba(52, 199, 89, 0.9);
    }
    
    .no-badge {
      background-color: rgba(255, 69, 58, 0.9);
    }
    
    .maybe-badge {
      background-color: rgba(255, 159, 10, 0.9);
    }
    
    .fade-in {
      opacity: 1;
    }
    
    .fade-out {
      opacity: 0;
    }
    
    .hidden {
      display: none;
    }
    
    .category-label {
      position: absolute;
      top: 20px;
      right: 20px;
      padding: 8px 16px;
      border-radius: 4px;
      font-weight: bold;
      color: white;
      text-transform: uppercase;
      font-size: 14px;
      opacity: 0;
      transition: opacity 0.3s;
    }
    
    .category-label.visible {
      opacity: 1;
    }
    
    .category-label.yes {
      background-color: rgba(52, 199, 89, 0.9);
    }
    
    .category-label.no {
      background-color: rgba(255, 69, 58, 0.9);
    }
    
    .category-label.maybe {
      background-color: rgba(255, 159, 10, 0.9);
    }
    
    .duplicate-warning {
      background-color: #fff3cd;
      color: #856404;
      padding: 10px 15px;
      border-radius: 4px;
      margin-top: 10px;
      display: none;
    }
    
    .duplicate-warning.visible {
      display: block;
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="title">Wedding Photo Sorter</div>
    <div class="stats" id="stats">
      <div class="stat-group">
        <span>Total Photos</span>
        <span class="stat-value" id="total-photos">0</span>
      </div>
      <div class="stat-group">
        <span>Sorted</span>
        <span class="stat-value" id="sorted-photos">0</span>
      </div>
      <div class="stat-group">
        <span>Remaining</span>
        <span class="stat-value" id="remaining-photos">0</span>
      </div>
      <div class="stat-group">
        <span>Yes</span>
        <span class="stat-value" id="yes-count">0</span>
      </div>
      <div class="stat-group">
        <span>No</span>
        <span class="stat-value" id="no-count">0</span>
      </div>
      <div class="stat-group">
        <span>Maybe</span>
        <span class="stat-value" id="maybe-count">0</span>
      </div>
    </div>
    <div>
      <button id="toggle-review">Review</button>
      <button id="export-btn" style="margin-left: 10px; background-color: #10a37f;">Export</button>
      <button id="revert-btn" style="margin-left: 10px; background-color: #e5534b;">Revert</button>
    </div>
  </div>
  
  <div id="setup-container" class="setup-container">
    <h2>Let's get started sorting your wedding photos!</h2>
    <p>This app will help you quickly sort through your photos using keyboard shortcuts.</p>
    <div id="resume-message" class="resume-message">
      Resuming previous sorting session...
    </div>
    <div style="margin: 30px 0;">
      <button id="select-source">Select Photos Folder</button>
      <div id="source-path" class="path-display"></div>
    </div>
  </div>
  
  <div id="photo-container" class="photo-container hidden">
    <img id="photo-view" class="photo-view" src="" alt="Wedding photo" />
    <div id="category-label" class="category-label"></div>
  </div>

  <div id="review-panel" class="hidden" style="padding: 12px 20px; background: #fff; border-bottom: 1px solid #ddd;">
    <div id="review-summary" style="font-size: 14px; color: #333; margin-bottom: 8px;"></div>
    <div id="review-tags" style="display: flex; gap: 12px; flex-wrap: wrap;"></div>
  </div>
  
  <div id="controls" class="controls hidden">
    <div class="control-group">
      <span class="key">←</span>
      <span class="action">Previous</span>
    </div>
    <div class="control-group">
      <span class="key">→</span>
      <span class="action">Next</span>
    </div>
    <div class="control-group" style="min-width: 320px;">
      <input id="tag-input" type="text" placeholder="Add tag and press Enter" list="all-tags" style="padding: 8px 10px; border: 1px solid #ccc; border-radius: 4px; width: 220px;" />
      <datalist id="all-tags"></datalist>
    </div>
  </div>
  
  <div id="duplicate-warning" class="duplicate-warning">
    ⚠️ Duplicate photos detected! Check the console for details.
  </div>
  
  <script>
    const { ipcRenderer } = require('electron');
    
    // Elements
    const setupContainer = document.getElementById('setup-container');
    const photoContainer = document.getElementById('photo-container');
    const controls = document.getElementById('controls');
    const photoView = document.getElementById('photo-view');
    const stats = document.getElementById('stats');
    const sourcePath = document.getElementById('source-path');
    const selectSourceBtn = document.getElementById('select-source');
    const tagInput = document.getElementById('tag-input');
    const tagOptions = document.getElementById('all-tags');
    let currentPhotoPath = null;
    let cachedAllTags = [];
    const reviewPanel = document.getElementById('review-panel');
    const reviewSummary = document.getElementById('review-summary');
    const reviewTags = document.getElementById('review-tags');
    const toggleReviewBtn = document.getElementById('toggle-review');
    const exportBtn = document.getElementById('export-btn');
    const revertBtn = document.getElementById('revert-btn');
    
    // Button event listeners
    selectSourceBtn.addEventListener('click', async () => {
      const result = await ipcRenderer.invoke('select-source-folder');
      if (result) {
        sourcePath.textContent = result.sourceFolder;
        stats.textContent = `Total Photos: ${result.totalPhotos}`;
        
        // Show resume message if there's existing metadata
        const resumeMessage = document.getElementById('resume-message');
        if (result.hasMetadata) {
          resumeMessage.classList.add('visible');
        }
        
        // Switch to photo view mode
        setupContainer.classList.add('hidden');
        photoContainer.classList.remove('hidden');
        controls.classList.remove('hidden');
        
        // Load the first photo with stats
        const photoData = {
          photo: result.firstPhoto,
          index: result.currentIndex || 0,  // Fixed: use currentIndex from result
          total: result.totalPhotos,
          stats: result.stats
        };
        loadPhoto(photoData);
      }
    });
    
    // Keyboard event listener
    document.addEventListener('keydown', async (event) => {
      // Only process keyboard events if we're in photo viewing mode
      if (photoContainer.classList.contains('hidden')) {
        return;
      }
      
      switch (event.key) {
        case 'ArrowLeft':
          event.preventDefault();
          const prevData = await ipcRenderer.invoke('get-prev-photo');
          if (prevData) {
            loadPhoto(prevData);
          }
          break;
          
        case 'ArrowRight':
          event.preventDefault();
          const nextData = await ipcRenderer.invoke('get-next-photo');
          if (nextData) {
            loadPhoto(nextData);
          }
          break;

        case 'Escape':
          event.preventDefault();
          if (currentPhotoPath) {
            try {
              await ipcRenderer.invoke('add-photo-tag', { filePath: currentPhotoPath, tag: 'skip' });
              refreshTagsUI();
            } catch (err) {
              console.error('Failed to add skip tag', err);
            }
          }
          break;
      }
    });
    
    // Helper function to load a photo
    function loadPhoto(photoData) {
      // Check if photo exists
      if (!photoData || !photoData.photo) {
        console.error('No photo data provided');
        return;
      }
      
      // Handle image loading errors
      photoView.onerror = () => {
        console.error('Failed to load image:', photoData.photo);
        photoView.alt = 'Failed to load image';
      };
      
      currentPhotoPath = photoData.photo;
      photoView.src = `file://${photoData.photo}`;
      stats.textContent = `Photo ${photoData.index + 1} of ${photoData.total}`;
      
      // Update category label
      const categoryLabel = document.getElementById('category-label');
      if (photoData.category) {
        categoryLabel.textContent = photoData.category.toUpperCase();
        categoryLabel.className = `category-label ${photoData.category} visible`;
      } else {
        categoryLabel.className = 'category-label';
      }

      // Update stats
      if (photoData.stats) {
        document.getElementById('total-photos').textContent = photoData.stats.total || 0;
        document.getElementById('sorted-photos').textContent = photoData.stats.categorizedTotal || 0;
        document.getElementById('remaining-photos').textContent = photoData.stats.remaining || 0;
        document.getElementById('yes-count').textContent = photoData.stats.categorized?.yes || 0;
        document.getElementById('no-count').textContent = photoData.stats.categorized?.no || 0;
        document.getElementById('maybe-count').textContent = photoData.stats.categorized?.maybe || 0;

        // Show duplicate warning if any duplicates found
        const duplicateWarning = document.getElementById('duplicate-warning');
        if (photoData.stats.duplicates && photoData.stats.duplicates.length > 0) {
          duplicateWarning.classList.add('visible');
          console.log('Duplicate photos found:', photoData.stats.duplicates);
        } else {
          duplicateWarning.classList.remove('visible');
        }
      }

      // Load tags for the current photo and all-known tags for autocomplete
      refreshTagsUI();
    }
    
    // Removed old categorization via arrow up/down/space

    // Tagging helpers
    async function refreshTagsUI() {
      try {
        if (!currentPhotoPath) return;
        const [photoTags, allTags] = await Promise.all([
          ipcRenderer.invoke('get-photo-tags', currentPhotoPath),
          ipcRenderer.invoke('get-all-tags')
        ]);

        // Render datalist options
        cachedAllTags = Array.isArray(allTags) ? allTags : [];
        tagOptions.innerHTML = '';
        cachedAllTags.forEach(t => {
          const opt = document.createElement('option');
          opt.value = t;
          tagOptions.appendChild(opt);
        });

        // Render chips below the image
        renderTagChips(photoTags || []);
      } catch (e) {
        // Non-fatal
        console.error('Failed to refresh tags UI', e);
      }
    }

    function renderTagChips(tags) {
      let chips = document.getElementById('tag-chips');
      if (!chips) {
        chips = document.createElement('div');
        chips.id = 'tag-chips';
        chips.style.position = 'absolute';
        chips.style.bottom = '20px';
        chips.style.left = '20px';
        chips.style.display = 'flex';
        chips.style.flexWrap = 'wrap';
        chips.style.gap = '8px';
        chips.style.maxWidth = 'calc(100% - 40px)';
        photoContainer.appendChild(chips);
      }
      chips.innerHTML = '';
      tags.forEach(tag => {
        const chip = document.createElement('span');
        chip.style.padding = '8px 12px';
        chip.style.background = 'rgba(255, 255, 255, 0.95)';
        chip.style.border = '1px solid rgba(0, 0, 0, 0.1)';
        chip.style.borderRadius = '6px';
        chip.style.fontSize = '13px';
        chip.style.fontWeight = '500';
        chip.style.display = 'inline-flex';
        chip.style.alignItems = 'center';
        chip.style.gap = '8px';
        chip.style.boxShadow = '0 2px 4px rgba(0, 0, 0, 0.1)';
        chip.style.color = '#333';

        const tagLabel = document.createElement('span');
        tagLabel.textContent = tag;
        chip.appendChild(tagLabel);

        const btn = document.createElement('button');
        btn.textContent = '×';
        btn.style.background = 'rgba(0, 0, 0, 0.05)';
        btn.style.color = '#666';
        btn.style.border = 'none';
        btn.style.borderRadius = '50%';
        btn.style.width = '20px';
        btn.style.height = '20px';
        btn.style.cursor = 'pointer';
        btn.style.display = 'flex';
        btn.style.alignItems = 'center';
        btn.style.justifyContent = 'center';
        btn.style.fontSize = '16px';
        btn.style.lineHeight = '1';
        btn.style.padding = '0';
        btn.style.transition = 'background 0.2s';
        btn.onmouseenter = () => {
          btn.style.background = 'rgba(0, 0, 0, 0.15)';
          btn.style.color = '#333';
        };
        btn.onmouseleave = () => {
          btn.style.background = 'rgba(0, 0, 0, 0.05)';
          btn.style.color = '#666';
        };
        btn.addEventListener('click', async () => {
          if (!currentPhotoPath) return;
          await ipcRenderer.invoke('remove-photo-tag', { filePath: currentPhotoPath, tag });
          refreshTagsUI();
        });
        chip.appendChild(btn);
        chips.appendChild(chip);
      });
    }

    tagInput.addEventListener('keydown', async (e) => {
      if (e.key === 'Enter') {
        const value = tagInput.value.trim();
        if (!value || !currentPhotoPath) return;
        try {
          await ipcRenderer.invoke('add-photo-tag', { filePath: currentPhotoPath, tag: value });
          tagInput.value = '';
          refreshTagsUI();
        } catch (err) {
          console.error('Failed to add tag', err);
        }
      } else if (e.key === 'Backspace') {
        if (tagInput.value === '') {
          // Remove the last tag chip if any
          const chips = document.getElementById('tag-chips');
          if (chips && chips.lastChild) {
            const lastLabel = chips.lastChild.firstChild ? chips.lastChild.firstChild.textContent : chips.lastChild.textContent;
            const tag = (lastLabel || '').trim();
            if (tag && currentPhotoPath) {
              try {
                await ipcRenderer.invoke('remove-photo-tag', { filePath: currentPhotoPath, tag });
                refreshTagsUI();
              } catch (err) {
                console.error('Failed to remove tag', err);
              }
            }
          }
        }
      }
    });

    // Quick-apply tags via number keys (1-9) when not typing in inputs
    document.addEventListener('keydown', async (e) => {
      const isTyping = document.activeElement && (document.activeElement.tagName === 'INPUT' || document.activeElement.tagName === 'TEXTAREA');
      if (isTyping && document.activeElement !== tagInput) return;
      if (!currentPhotoPath) return;
      const num = parseInt(e.key, 10);
      if (!Number.isNaN(num) && num >= 1 && num <= 9) {
        const idx = num - 1;
        if (cachedAllTags[idx]) {
          try {
            await ipcRenderer.invoke('add-photo-tag', { filePath: currentPhotoPath, tag: cachedAllTags[idx] });
            refreshTagsUI();
          } catch (err) {
            console.error('Failed to quick-apply tag', err);
          }
        }
      }
    });

    // Review panel toggle
    toggleReviewBtn.addEventListener('click', async () => {
      const isHidden = reviewPanel.classList.contains('hidden');
      if (isHidden) {
        await renderReview();
        reviewPanel.classList.remove('hidden');
      } else {
        reviewPanel.classList.add('hidden');
      }
    });

    async function renderReview() {
      try {
        const s = await ipcRenderer.invoke('get-stats');
        if (!s) return;
        const taggedTotal = Object.values(s.tags || {}).reduce((a, b) => a + b, 0);
        reviewSummary.textContent = `Total: ${s.total} • Tagged: ${taggedTotal} • Untagged: ${s.untagged}`;
        reviewTags.innerHTML = '';
        Object.entries(s.tags || {}).sort((a, b) => b[1] - a[1]).forEach(([tag, count]) => {
          const pill = document.createElement('span');
          pill.textContent = `${tag} (${count})`;
          pill.style.padding = '6px 10px';
          pill.style.background = '#f2f2f2';
          pill.style.borderRadius = '999px';
          pill.style.fontSize = '12px';
          reviewTags.appendChild(pill);
        });
      } catch (e) {
        console.error('Failed to render review', e);
      }
    }

    // Export flow (dry run then confirm)
    exportBtn.addEventListener('click', async () => {
      try {
        const plan = await ipcRenderer.invoke('export-dry-run');
        if (!plan) return;
        const tagList = Object.entries(plan.perTag || {})
          .sort((a, b) => b[1] - a[1])
          .map(([t, c]) => `${t}: ${c}`)
          .join(', ');
        const msg = `Ready to export?\n\n` +
          `Total: ${plan.total}\nTagged: ${plan.tagged}\nUntagged: ${plan.untagged}\n` +
          (tagList ? `\nPer-tag: ${tagList}\n` : '');
        const ok = window.confirm(msg);
        if (!ok) return;
        const res = await ipcRenderer.invoke('export-execute');
        if (res && res.ok) {
          alert(`Export complete. Moved: ${res.moved}, Linked/Copied: ${res.linked}`);
        } else {
          alert(`Export failed: ${res && res.error ? res.error : 'Unknown error'}`);
        }
      } catch (e) {
        console.error('Export error', e);
        alert('Export failed. See console for details.');
      }
    });

    // Revert flow (debug): move files back to root, delete tag dirs, delete JSON
    revertBtn.addEventListener('click', async () => {
      const ok = window.confirm('Revert export? This will move photos back to the root, delete tag folders, and delete project/stat/metadata JSON.');
      if (!ok) return;
      try {
        const res = await ipcRenderer.invoke('revert-export');
        if (res && res.ok) {
          alert(`Revert complete. Restored: ${res.restored}, removed dupes: ${res.removed}`);
        } else {
          alert(`Revert failed: ${res && res.error ? res.error : 'Unknown error'}`);
        }
      } catch (e) {
        console.error('Revert error', e);
        alert('Revert failed. See console for details.');
      }
    });
  </script>
</body>
</html>
